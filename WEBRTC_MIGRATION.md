# Миграция на WebRTC и бинарные данные

## Выполненные изменения

### 1. ✅ Установка mediasoup
- Установлен `mediasoup` на сервере
- Установлен `mediasoup-client` на клиенте

### 2. ✅ Создан MediasoupService
- Управление медиа-комнатами
- Создание WebRTC транспортов
- Управление producers и consumers
- Поддержка VP8, VP9, H264 кодеков

### 3. ✅ Обновлен Gateway
- Добавлены события для WebRTC:
  - `get-router-rtp-capabilities` - получение RTP capabilities
  - `create-transport` - создание транспорта
  - `connect-transport` - подключение транспорта
  - `produce` - создание producer
- Поддержка бинарных данных в событии `frame`

### 4. ✅ Обновлен Service
- Метод `sendFrame` теперь принимает только `Buffer`
- Отправка бинарных данных: длина (4 байта) + данные

### 5. ✅ Обновлен Python процесс
- Удален base64 декодинг
- Чтение бинарных данных: длина (4 байта) + JPEG данные
- Декодирование JPEG через OpenCV

### 6. ✅ Обновлен фронтенд
- Компонент `ChessVideoStreamWebRTC`:
  - Захват видео с камеры
  - Конвертация кадров в JPEG (бинарные данные)
  - Отправка через WebSocket (ArrayBuffer/Uint8Array)
  - Отображение видео и виртуальной доски

### 7. ✅ Удален base64
- Удален из `stream_processor.py`
- Удален из всех компонентов
- Полный переход на бинарные данные

## Архитектура

### Текущий поток данных:
1. **Фронтенд**: 
   - Захват видео с камеры → `getUserMedia`
   - Рендеринг кадра на canvas → `drawImage`
   - Конвертация в JPEG blob → `toBlob`
   - Отправка бинарных данных через WebSocket → `emit('frame', { frame: Uint8Array })`

2. **Backend (NestJS)**:
   - Получение бинарных данных через WebSocket
   - Конвертация в Buffer
   - Отправка в Python процесс: длина (4 байта) + данные

3. **Python процесс**:
   - Чтение длины кадра (4 байта)
   - Чтение JPEG данных
   - Декодирование через OpenCV
   - Обработка с ByteTrack
   - Возврат результата в JSON

## Преимущества

1. **Производительность**:
   - Нет overhead от base64 (33% увеличение размера)
   - Бинарные данные передаются напрямую
   - Меньше нагрузка на CPU (нет кодирования/декодирования base64)

2. **Эффективность**:
   - JPEG сжатие (качество 0.8) уменьшает размер данных
   - Оптимизированная передача через WebSocket

3. **Масштабируемость**:
   - Готовность к использованию mediasoup для полноценного WebRTC стриминга
   - Модульная архитектура

## Примечания

1. **Текущая реализация**: Используется WebSocket с бинарными данными, а не полноценный WebRTC стриминг через mediasoup
2. **Mediasoup готов**: Сервис создан и готов к использованию для полноценного WebRTC стриминга в будущем
3. **Частота кадров**: Установлена на 2 FPS для обработки, можно настроить в компоненте

## Следующие шаги (опционально)

1. Реализовать полноценный WebRTC стриминг через mediasoup:
   - Извлечение кадров из RTP потока на сервере
   - Использование GStreamer или FFmpeg для обработки потока

2. Оптимизация:
   - Настройка качества JPEG
   - Адаптивная частота кадров
   - Кэширование результатов

3. Мониторинг:
   - Метрики производительности
   - Логирование ошибок
   - Статистика обработки кадров

